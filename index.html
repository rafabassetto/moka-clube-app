<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moka Clube App</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para traduzir JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react/dist/lucide-react.min.js"></script>

    <!-- FIREBASE SDK (Compat Version para HTML simples) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        /* Esconder scrollbar mas manter funcionalidade */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Importando React hooks do global
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDnElIN9JV7OtApqh4orYVXjdpr41jtyHc",
            authDomain: "moka-clube-app.firebaseapp.com",
            projectId: "moka-clube-app",
            storageBucket: "moka-clube-app.firebasestorage.app",
            messagingSenderId: "921502412834",
            appId: "1:921502412834:web:f72730a5f7444cb440da7b"
        };

        // Inicializando Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- COMPONENTES DE √çCONE ---
        const Icon = ({ name, size = 24, className, ...props }) => {
            const lucideIcons = window.lucide ? window.lucide.icons : {};
            const IconComponent = lucideIcons[name];
            // Fallback simples se lucide n√£o carregar
            if (!IconComponent) return <span className="text-xs">Icon</span>;
            
            return (
                <i data-lucide={name} className={className} width={size} height={size} {...props}></i>
            );
        };

        // Mapeamento de componentes
        const Coffee = (props) => <Icon name="Coffee" {...props} />;
        const Timer = (props) => <Icon name="Timer" {...props} />;
        const Users = (props) => <Icon name="Users" {...props} />;
        const PlusCircle = (props) => <Icon name="PlusCircle" {...props} />;
        const Heart = (props) => <Icon name="Heart" {...props} />;
        const Clock = (props) => <Icon name="Clock" {...props} />;
        const Droplet = (props) => <Icon name="Droplet" {...props} />;
        const Thermometer = (props) => <Icon name="Thermometer" {...props} />;
        const ChevronRight = (props) => <Icon name="ChevronRight" {...props} />;
        const Play = (props) => <Icon name="Play" {...props} />;
        const Pause = (props) => <Icon name="Pause" {...props} />;
        const RotateCcw = (props) => <Icon name="RotateCcw" {...props} />;
        const Search = (props) => <Icon name="Search" {...props} />;
        const Award = (props) => <Icon name="Award" {...props} />;
        const Settings = (props) => <Icon name="Settings" {...props} />;
        const Star = (props) => <Icon name="Star" {...props} />;
        const Zap = (props) => <Icon name="Zap" {...props} />;
        const MapPin = (props) => <Icon name="MapPin" {...props} />;
        const BarChart2 = (props) => <Icon name="BarChart2" {...props} />;
        const Youtube = (props) => <Icon name="Youtube" {...props} />;
        const Save = (props) => <Icon name="Save" {...props} />;
        const Shield = (props) => <Icon name="Shield" {...props} />;
        const Loader = (props) => <Icon name="Loader" {...props} />;

        // --- DADOS E TEMAS ---
        const THEMES = {
            classic: {
                id: 'classic',
                name: 'Moka Classic',
                bg: 'bg-gray-50',
                cardBg: 'bg-white',
                textMain: 'text-zinc-900',
                textSec: 'text-gray-500',
                accent: 'bg-red-600',
                accentText: 'text-red-600',
                navBg: 'bg-white',
                headerBg: 'bg-zinc-900',
                headerText: 'text-white'
            },
            dark: {
                id: 'dark',
                name: 'Midnight Roast',
                bg: 'bg-zinc-900',
                cardBg: 'bg-zinc-800',
                textMain: 'text-white',
                textSec: 'text-zinc-400',
                accent: 'bg-yellow-500',
                accentText: 'text-yellow-500',
                navBg: 'bg-zinc-900',
                headerBg: 'bg-black',
                headerText: 'text-white'
            },
            nature: {
                id: 'nature',
                name: 'Fazenda',
                bg: 'bg-stone-100',
                cardBg: 'bg-[#fdfbf7]',
                textMain: 'text-stone-800',
                textSec: 'text-stone-500',
                accent: 'bg-green-700',
                accentText: 'text-green-700',
                navBg: 'bg-[#fdfbf7]',
                headerBg: 'bg-stone-800',
                headerText: 'text-[#fdfbf7]'
            }
        };

        // Receitas Iniciais (Fallback)
        const INITIAL_OFFICIAL_RECIPES = [
            {
                id: 'static-1',
                title: "Catua√≠ Vermelho - Norte Pioneiro",
                region: "Norte Pioneiro, PR",
                method: "Hario V60",
                ratio: "1:16",
                notes: "Notas de caramelo, acidez c√≠trica m√©dia.",
                author: "Moka Clube",
                likes: 342,
                difficulty: "M√©dia",
                temp: "93¬∞C",
                videoId: "w2-S7Ww2rSc"
            }
        ];

        const COMMUNITY_RECIPES = [
            { id: 101, title: "Aeropress Invertida Power", coffee: "Moka da Matina", author: "Ricardo S.", method: "Aeropress", likes: 56, time_ago: "2h atr√°s", desc: "Uma receita pra quem gosta de corpo alto." },
            { id: 102, title: "V60 Gelado (Japanese Style)", coffee: "Eti√≥pia Brasileiro", author: "Ana Clara", method: "V60", likes: 89, time_ago: "5h atr√°s", desc: "Substitu√≠ 40% da √°gua por gelo na jarra." }
        ];

        const BREW_METHODS = [
            { name: "Hario V60", icon: "V60", defaultTime: 180 },
            { name: "Prensa Francesa", icon: "PF", defaultTime: 240 },
            { name: "Aeropress", icon: "AP", defaultTime: 120 },
            { name: "Chemex", icon: "CH", defaultTime: 210 },
            { name: "Koar", icon: "KR", defaultTime: 180 },
        ];

        const BADGES = [
            { id: 1, name: "Pioneiro do Norte", iconName: "MapPin", desc: "Provou 5 caf√©s do PR", earned: true },
            { id: 2, name: "Alquimista V60", iconName: "Coffee", desc: "10 receitas criadas", earned: true },
            { id: 3, name: "Ca√ßador de Acidez", iconName: "Zap", desc: "Avaliou 5 caf√©s c√≠tricos", earned: false },
            { id: 4, name: "Mestre da Prensa", iconName: "Timer", desc: "Usou timer 50x", earned: false },
        ];

        // --- FUN√á√ïES AUXILIARES ---
        const getYoutubeEmbedUrl = (videoId) => `https://www.youtube.com/embed/${videoId}`;
        const extractVideoId = (url) => {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        // --- COMPONENTES ---

        const AdminRecipeForm = ({ theme, onSave, onCancel, isSaving }) => {
            const [formData, setFormData] = useState({
                title: '', region: '', method: 'Hario V60', ratio: '1:16', temp: '93¬∞C', notes: '', videoUrl: ''
            });

            const handleSubmit = () => {
                const videoId = formData.videoUrl ? extractVideoId(formData.videoUrl) : '';
                onSave({ ...formData, videoId, author: 'Moka Clube', likes: 0 });
            };

            return (
                <div className={`p-4 ${theme.bg} min-h-screen pb-24`}>
                    <div className="flex items-center gap-2 mb-6">
                        <Shield className={theme.accentText} size={24} />
                        <h2 className={`text-xl font-bold ${theme.textMain}`}>Nova Receita Oficial</h2>
                    </div>
                    <div className={`${theme.cardBg} p-5 rounded-xl border ${theme.id === 'dark' ? 'border-zinc-700' : 'border-gray-200'} space-y-4`}>
                        <div>
                            <label className={`block text-xs font-bold ${theme.textSec} mb-1 uppercase`}>Nome do Caf√©</label>
                            <input type="text" className={`w-full p-2 rounded border ${theme.id === 'dark' ? 'bg-zinc-900 border-zinc-700 text-white' : 'bg-white border-gray-300'} text-sm`} placeholder="Ex: Catua√≠ Amarelo..." value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
                        </div>
                        <div>
                            <label className={`block text-xs font-bold ${theme.textSec} mb-1 uppercase`}>Regi√£o</label>
                            <input type="text" className={`w-full p-2 rounded border ${theme.id === 'dark' ? 'bg-zinc-900 border-zinc-700 text-white' : 'bg-white border-gray-300'} text-sm`} placeholder="Ex: Chapada Diamantina, BA" value={formData.region} onChange={e => setFormData({...formData, region: e.target.value})} />
                        </div>
                        <div className="flex gap-2">
                            <div className="flex-1">
                                <label className={`block text-xs font-bold ${theme.textSec} mb-1 uppercase`}>M√©todo</label>
                                <select className={`w-full p-2 rounded border ${theme.id === 'dark' ? 'bg-zinc-900 border-zinc-700 text-white' : 'bg-white border-gray-300'} text-sm`} value={formData.method} onChange={e => setFormData({...formData, method: e.target.value})}>
                                    {BREW_METHODS.map(m => <option key={m.name} value={m.name}>{m.name}</option>)}
                                </select>
                            </div>
                            <div className="w-1/3">
                                <label className={`block text-xs font-bold ${theme.textSec} mb-1 uppercase`}>Temp.</label>
                                <input type="text" className={`w-full p-2 rounded border ${theme.id === 'dark' ? 'bg-zinc-900 border-zinc-700 text-white' : 'bg-white border-gray-300'} text-sm`} placeholder="93¬∞C" value={formData.temp} onChange={e => setFormData({...formData, temp: e.target.value})} />
                            </div>
                        </div>
                        <div>
                            <label className={`block text-xs font-bold ${theme.textSec} mb-1 uppercase flex items-center gap-1`}><Youtube size={14} /> Link do V√≠deo</label>
                            <input type="text" className={`w-full p-2 rounded border ${theme.id === 'dark' ? 'bg-zinc-900 border-zinc-700 text-white' : 'bg-white border-gray-300'} text-sm`} placeholder="Link do YouTube" value={formData.videoUrl} onChange={e => setFormData({...formData, videoUrl: e.target.value})} />
                        </div>
                        <div>
                            <label className={`block text-xs font-bold ${theme.textSec} mb-1 uppercase`}>Notas Sensoriais</label>
                            <textarea className={`w-full p-2 rounded border ${theme.id === 'dark' ? 'bg-zinc-900 border-zinc-700 text-white' : 'bg-white border-gray-300'} text-sm`} rows="3" placeholder="Descreva o sabor..." value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})}></textarea>
                        </div>
                        <div className="flex gap-3 pt-2">
                            <button onClick={onCancel} className={`flex-1 py-3 rounded-lg font-bold text-sm ${theme.textSec} border border-transparent hover:bg-black/5`}>Cancelar</button>
                            <button 
                                onClick={handleSubmit} 
                                disabled={isSaving}
                                className={`flex-1 py-3 rounded-lg font-bold text-sm text-white ${theme.accent} shadow-md flex items-center justify-center gap-2 ${isSaving ? 'opacity-70' : ''}`}
                            >
                                {isSaving ? <span className="animate-spin mr-1">‚è≥</span> : <Save size={16} />} 
                                {isSaving ? 'Salvando...' : 'Publicar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SensoryWheel = ({ theme }) => {
            const [attributes, setAttributes] = useState({ acidez: 3, docura: 4, corpo: 2, amargor: 1, finalizacao: 3 });
            const calculatePoints = () => {
                const keys = Object.keys(attributes);
                const total = keys.length;
                const centerX = 100, centerY = 100, radius = 80;
                return keys.map((key, i) => {
                    const value = attributes[key];
                    const angle = (Math.PI * 2 * i) / total - Math.PI / 2;
                    const r = (value / 5) * radius;
                    const x = centerX + r * Math.cos(angle);
                    const y = centerY + r * Math.sin(angle);
                    return `${x},${y}`;
                }).join(' ');
            };
            const handleChange = (key, val) => setAttributes(prev => ({ ...prev, [key]: parseInt(val) }));

            return (
                <div className={`p-6 rounded-2xl ${theme.cardBg} shadow-sm border border-gray-100 mb-6`}>
                    <div className="flex items-center gap-2 mb-4">
                        <BarChart2 size={20} className={theme.accentText} />
                        <h3 className={`font-bold text-lg ${theme.textMain}`}>Roda Sensorial</h3>
                    </div>
                    <div className="flex flex-col md:flex-row gap-8 items-center">
                        <div className="relative w-48 h-48 flex-shrink-0">
                            <svg width="200" height="200" viewBox="0 0 200 200">
                                {[1, 2, 3, 4, 5].map(step => <circle key={step} cx="100" cy="100" r={(step/5)*80} fill="none" stroke={theme.id === 'dark' ? '#444' : '#e5e7eb'} strokeWidth="1" />)}
                                <polygon points={calculatePoints()} fill={theme.id === 'classic' ? 'rgba(220, 38, 38, 0.2)' : theme.id === 'nature' ? 'rgba(21, 128, 61, 0.2)' : 'rgba(234, 179, 8, 0.2)'} stroke={theme.id === 'classic' ? '#DC2626' : theme.id === 'nature' ? '#15803d' : '#EAB308'} strokeWidth="2" />
                            </svg>
                            <div className={`absolute top-0 left-1/2 -translate-x-1/2 text-[10px] font-bold ${theme.textSec}`}>ACIDEZ</div>
                            <div className={`absolute bottom-0 left-1/2 -translate-x-1/2 text-[10px] font-bold ${theme.textSec}`}>CORPO</div>
                            <div className={`absolute right-0 top-1/3 text-[10px] font-bold ${theme.textSec}`}>DO√áURA</div>
                            <div className={`absolute left-0 top-1/3 text-[10px] font-bold ${theme.textSec}`}>FINAL</div>
                            <div className={`absolute right-2 bottom-1/4 text-[10px] font-bold ${theme.textSec}`}>AMARGOR</div>
                        </div>
                        <div className="w-full space-y-3">
                            {Object.entries(attributes).map(([key, val]) => (
                                <div key={key} className="flex items-center gap-2 text-xs">
                                    <span className={`w-16 capitalize font-medium ${theme.textSec}`}>{key}</span>
                                    <input type="range" min="1" max="5" step="1" value={val} onChange={(e) => handleChange(key, e.target.value)} className={`w-full h-1.5 rounded-lg appearance-none cursor-pointer bg-gray-200`} style={{ accentColor: theme.id === 'classic' ? '#DC2626' : theme.id === 'nature' ? '#15803d' : '#EAB308' }} />
                                    <span className={`w-4 text-center font-bold ${theme.textMain}`}>{val}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Header = ({ theme, baristaMode }) => (
            <header className={`${theme.headerBg} ${theme.headerText} p-4 sticky top-0 z-50 shadow-md flex justify-between items-center transition-colors duration-300`}>
                <div className="flex items-center gap-2">
                    <div className={`${theme.accent} p-1.5 rounded-lg`}><Coffee size={20} className="text-white" /></div>
                    <h1 className="font-bold text-lg tracking-wider">MOKA <span className="font-light opacity-70">APP</span></h1>
                </div>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border relative ${theme.id === 'nature' ? 'bg-stone-600 border-stone-500' : 'bg-zinc-700 border-zinc-600'}`}>
                    {baristaMode ? <Shield size={14} className="text-yellow-400" /> : "MC"}
                </div>
            </header>
        );

        const RecipeCard = ({ recipe, isOfficial, theme }) => (
            <div className={`${theme.cardBg} rounded-xl shadow-sm border border-opacity-50 border-gray-200 overflow-hidden mb-4 hover:shadow-md transition-all`}>
                {isOfficial && recipe.videoId && (
                    <div className="w-full aspect-video bg-black relative">
                        <iframe width="100%" height="100%" src={getYoutubeEmbedUrl(recipe.videoId)} title={recipe.title} frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen className="absolute inset-0"></iframe>
                    </div>
                )}
                <div className="p-4">
                    <div className="flex justify-between items-start mb-2">
                        <span className={`text-xs font-bold px-2 py-1 rounded-full ${isOfficial ? `${theme.headerBg} ${theme.headerText}` : 'bg-gray-100 text-gray-600'}`}>{recipe.method}</span>
                        <div className={`flex items-center gap-1 ${theme.textSec} text-sm`}><Heart size={14} /><span>{recipe.likes}</span></div>
                    </div>
                    <h3 className={`font-bold text-lg ${theme.textMain} leading-tight mb-1`}>{recipe.title}</h3>
                    {isOfficial && <p className={`text-xs ${theme.accentText} font-bold mb-2 uppercase tracking-wide`}>{recipe.region}</p>}
                    {!isOfficial && <p className={`text-xs ${theme.textSec} mb-2`}>por {recipe.author} ‚Ä¢ {recipe.coffee}</p>}
                    <p className={`text-sm ${theme.textSec} mb-4 line-clamp-2`}>{isOfficial ? recipe.notes : recipe.desc}</p>
                    {isOfficial && (
                        <div className="flex items-center justify-between mt-3 pt-3 border-t border-gray-100 border-opacity-50">
                            <div className={`flex gap-4 text-xs ${theme.textSec} font-medium`}>
                                <span className="flex items-center gap-1"><Droplet size={12}/> {recipe.ratio}</span>
                                <span className="flex items-center gap-1"><Thermometer size={12}/> {recipe.temp}</span>
                            </div>
                            <button className={`${theme.accentText} text-sm font-bold flex items-center gap-1 hover:brightness-110`}>Ver Receita <ChevronRight size={16} /></button>
                        </div>
                    )}
                    {!isOfficial && (
                        <div className="flex items-center justify-between mt-2">
                            <div className="flex -space-x-2"><div className="w-6 h-6 rounded-full bg-gray-300 border-2 border-white"></div><div className="w-6 h-6 rounded-full bg-gray-400 border-2 border-white"></div></div>
                            <button className={`${theme.textMain} text-sm font-bold`}>Ler</button>
                        </div>
                    )}
                </div>
            </div>
        );

        const TimerView = ({ theme }) => {
            const [activeMethod, setActiveMethod] = useState(BREW_METHODS[0]);
            const [time, setTime] = useState(0);
            const [isActive, setIsActive] = useState(false);

            useEffect(() => {
                let interval = null;
                if (isActive) interval = setInterval(() => setTime((time) => time + 1), 1000);
                else if (!isActive && time !== 0) clearInterval(interval);
                return () => clearInterval(interval);
            }, [isActive, time]);

            const toggleTimer = () => setIsActive(!isActive);
            const resetTimer = () => { setIsActive(false); setTime(0); };
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };
            const getCurrentInstruction = () => {
                if (time < 30) return { title: "Bloom", desc: "Molhe todo o p√≥ com 50g de √°gua" };
                if (time < 90) return { title: "Despejo Principal", desc: "Movimentos circulares lentos" };
                if (time < 150) return { title: "Finaliza√ß√£o", desc: "Mantenha o n√≠vel da √°gua" };
                return { title: "Extra√ß√£o Final", desc: "Aguarde terminar de pingar" };
            };
            const currentInstruction = getCurrentInstruction();

            return (
                <div className="p-4 pb-24">
                    <h2 className={`text-xl font-bold mb-4 ${theme.textMain}`}>Barista de Bolso</h2>
                    <div className="flex gap-3 overflow-x-auto pb-4 no-scrollbar mb-4">
                        {BREW_METHODS.map((m) => (
                            <button key={m.name} onClick={() => { setActiveMethod(m); resetTimer(); }} className={`flex flex-col items-center justify-center min-w-[80px] h-20 rounded-xl border transition-all ${activeMethod.name === m.name ? `${theme.headerBg} ${theme.headerText} border-transparent shadow-lg` : `${theme.cardBg} ${theme.textSec} border-gray-200`}`}>
                                <span className="text-lg font-bold mb-1">{m.name === "Hario V60" ? "V60" : m.name.substring(0,2)}</span>
                                <span className="text-[10px] uppercase font-bold tracking-wider">{m.name.split(' ')[0]}</span>
                            </button>
                        ))}
                    </div>
                    <div className="flex flex-col items-center justify-center py-8">
                        <div className="relative w-64 h-64 flex items-center justify-center">
                            <div className={`absolute w-full h-full rounded-full border-4 ${theme.id === 'dark' ? 'border-zinc-700' : 'border-gray-200'}`}></div>
                            <div className={`absolute w-full h-full rounded-full border-4 border-t-current border-r-current transition-all duration-1000 ${isActive ? 'animate-spin-slow' : ''} ${theme.accentText}`} style={{ borderRightColor: 'transparent', borderBottomColor: 'transparent', borderLeftColor: 'transparent' }}></div>
                            <div className="text-center z-10">
                                <div className={`text-6xl font-black ${theme.textMain} tabular-nums`}>{formatTime(time)}</div>
                                <div className={`font-medium text-sm mt-1 uppercase tracking-widest ${theme.textSec}`}>{isActive ? 'Extraindo' : 'Pronto'}</div>
                            </div>
                        </div>
                    </div>
                    <div className={`${theme.cardBg} border ${theme.id === 'dark' ? 'border-zinc-700' : 'border-red-100'} p-4 rounded-xl mb-8 text-center transition-all shadow-sm`}>
                        <h3 className={`font-bold text-lg ${theme.accentText}`}>{currentInstruction.title}</h3>
                        <p className={`${theme.textSec} text-sm opacity-90`}>{currentInstruction.desc}</p>
                    </div>
                    <div className="flex justify-center gap-6">
                        <button onClick={resetTimer} className={`w-14 h-14 rounded-full flex items-center justify-center hover:opacity-80 ${theme.id === 'dark' ? 'bg-zinc-800 text-white' : 'bg-gray-200 text-gray-600'}`}><RotateCcw size={24} /></button>
                        <button onClick={toggleTimer} className={`w-20 h-20 rounded-full flex items-center justify-center shadow-xl transition-transform active:scale-95 ${isActive ? `${theme.headerBg} ${theme.headerText}` : `${theme.accent} text-white`}`}>{isActive ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" className="ml-1" />}</button>
                    </div>
                </div>
            );
        };

        const FeedView = ({ theme, goToRecipe, recipes, baristaMode, setView, isLoading }) => (
            <div className="p-4 pb-24">
                <div className={`${theme.headerBg} rounded-2xl p-5 mb-6 text-white relative overflow-hidden shadow-lg border border-zinc-800`}>
                    <div className={`absolute top-0 right-0 w-32 h-32 ${theme.accent} rounded-full blur-3xl opacity-30 translate-x-10 -translate-y-10`}></div>
                    <span className={`${theme.accent} text-[10px] font-bold px-2 py-1 rounded mb-2 inline-block text-white`}>CLUBE DE ASSINATURA</span>
                    <h2 className="relative z-10 text-xl font-bold mb-1">Caf√© do M√™s: Piat√£</h2>
                    <p className="relative z-10 text-gray-300 text-sm mb-4 max-w-[80%]">Direto da Chapada Diamantina, notas de mela√ßo.</p>
                    <button onClick={goToRecipe} className={`relative z-10 ${theme.cardBg} ${theme.textMain} px-4 py-2 rounded-lg text-sm font-bold hover:brightness-90 transition-colors`}>Avaliar este Caf√©</button>
                </div>
                <div className="flex items-center justify-between mb-4">
                    <h3 className={`font-bold text-lg ${theme.textMain}`}>Receitas Oficiais</h3>
                    {baristaMode ? (
                        <button onClick={() => setView('admin')} className={`flex items-center gap-1 ${theme.accentText} text-xs font-bold border border-current px-2 py-1 rounded-full animate-pulse`}><PlusCircle size={14} /> ADICIONAR NOVA</button>
                    ) : (
                        <button className={`${theme.accentText} text-sm font-bold`}>Ver todas</button>
                    )}
                </div>
                {isLoading && (
                    <div className="text-center py-4 text-gray-400">
                         <span className="animate-spin inline-block mr-2">‚è≥</span> Carregando receitas do clube...
                    </div>
                )}
                {/* Mesclar receitas est√°ticas iniciais com as do Firebase */}
                {[...recipes, ...INITIAL_OFFICIAL_RECIPES].filter((v,i,a)=>a.findIndex(v2=>(v2.id===v.id))===i).map(recipe => <RecipeCard key={recipe.id} recipe={recipe} isOfficial={true} theme={theme} />)}
            </div>
        );

        const CommunityView = ({ theme }) => (
            <div className="p-4 pb-24">
                <div className={`flex items-center gap-2 mb-6 ${theme.cardBg} border ${theme.id === 'dark' ? 'border-zinc-700' : 'border-gray-200'} p-2 rounded-lg`}>
                    <Search size={20} className="text-gray-400 ml-2" />
                    <input type="text" placeholder="Buscar receitas..." className={`bg-transparent w-full p-1 outline-none ${theme.textMain} text-sm`} />
                </div>
                <div className="flex justify-between items-end mb-4">
                    <div><h3 className={`font-bold text-xl ${theme.textMain}`}>Comunidade Moka</h3><p className={`text-xs ${theme.textSec}`}>O que os membros est√£o bebendo</p></div>
                    <button className={`${theme.headerBg} ${theme.headerText} p-2 rounded-full shadow-lg`}><PlusCircle size={24} /></button>
                </div>
                {COMMUNITY_RECIPES.map(recipe => <RecipeCard key={recipe.id} recipe={recipe} isOfficial={false} theme={theme} />)}
            </div>
        );

        const ProfileView = ({ theme, setTheme, baristaMode, setBaristaMode }) => (
            <div className="p-4 pb-24">
                <div className={`${theme.cardBg} rounded-xl p-6 shadow-sm border ${theme.id === 'dark' ? 'border-zinc-700' : 'border-gray-100'} mb-6 text-center`}>
                    <div className="w-20 h-20 bg-gray-300 rounded-full mx-auto mb-3 overflow-hidden border-4 border-white shadow-sm flex items-center justify-center text-4xl">üë®‚Äçü¶≤</div>
                    <h2 className={`font-bold text-xl ${theme.textMain}`}>S√≥cio Fundador</h2>
                    <p className={`text-sm ${theme.textSec} mb-4`}>Membro desde 2012</p>
                    <div className="flex justify-center gap-8 border-t border-gray-100 pt-4">
                        <div className="text-center"><span className={`block font-bold text-lg ${theme.accentText}`}>1,250</span><span className="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Pontos</span></div>
                        <div className="text-center"><span className={`block font-bold text-lg ${theme.textMain}`}>N√≠vel 5</span><span className="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Mestre</span></div>
                    </div>
                </div>
                <div className={`mb-6 p-4 rounded-xl border-2 border-dashed ${baristaMode ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200'} transition-all`}>
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3"><div className={`p-2 rounded-full ${baristaMode ? 'bg-yellow-400 text-black' : 'bg-gray-200 text-gray-400'}`}><Shield size={20} /></div><div><h4 className={`font-bold text-sm ${baristaMode ? 'text-zinc-900' : theme.textMain}`}>Modo Barista (Admin)</h4><p className="text-[10px] text-gray-500">Habilita envio de receitas</p></div></div>
                        <button onClick={() => setBaristaMode(!baristaMode)} className={`px-3 py-1 rounded-full text-xs font-bold ${baristaMode ? 'bg-zinc-900 text-white' : 'bg-gray-200 text-gray-500'}`}>{baristaMode ? 'ATIVO' : 'OFF'}</button>
                    </div>
                </div>
                <div className="mb-8">
                    <h3 className={`font-bold text-lg ${theme.textMain} mb-4 flex items-center gap-2`}><Award className={theme.accentText} size={20}/> Conquistas</h3>
                    <div className="grid grid-cols-2 gap-3">
                        {BADGES.map(badge => (
                            <div key={badge.id} className={`${theme.cardBg} p-3 rounded-lg border ${theme.id === 'dark' ? 'border-zinc-700' : 'border-gray-100'} flex items-start gap-3 ${!badge.earned ? 'opacity-50 grayscale' : ''}`}>
                                <div className={`p-2 rounded-full ${theme.bg} ${theme.accentText}`}><Icon name={badge.iconName} size={16} /></div>
                                <div><h4 className={`font-bold text-sm ${theme.textMain}`}>{badge.name}</h4><p className="text-[10px] text-gray-500 leading-tight mt-1">{badge.desc}</p></div>
                            </div>
                        ))}
                    </div>
                </div>
                <div className={`${theme.cardBg} rounded-xl p-4 shadow-sm border ${theme.id === 'dark' ? 'border-zinc-700' : 'border-gray-100'}`}>
                    <h3 className={`font-bold text-md ${theme.textMain} mb-4 flex items-center gap-2`}><Settings size={18} /> Apar√™ncia</h3>
                    <div className="space-y-3">
                        <button onClick={() => setTheme(THEMES.classic)} className={`w-full flex items-center justify-between p-3 rounded-lg border-2 ${theme.id === 'classic' ? 'border-red-600 bg-red-50' : 'border-gray-100'}`}><div className="flex items-center gap-2"><div className="w-4 h-4 rounded-full bg-red-600"></div><span className="text-sm font-bold text-zinc-800">Moka Classic</span></div>{theme.id === 'classic' && <Star size={14} className="text-red-600 fill-current" />}</button>
                        <button onClick={() => setTheme(THEMES.dark)} className={`w-full flex items-center justify-between p-3 rounded-lg border-2 ${theme.id === 'dark' ? 'border-yellow-500 bg-zinc-800' : 'border-gray-100'}`}><div className="flex items-center gap-2"><div className="w-4 h-4 rounded-full bg-zinc-900 border border-gray-600"></div><span className={`text-sm font-bold ${theme.id === 'dark' ? 'text-white' : 'text-zinc-600'}`}>Midnight Roast</span></div>{theme.id === 'dark' && <Star size={14} className="text-yellow-500 fill-current" />}</button>
                        <button onClick={() => setTheme(THEMES.nature)} className={`w-full flex items-center justify-between p-3 rounded-lg border-2 ${theme.id === 'nature' ? 'border-green-700 bg-stone-100' : 'border-gray-100'}`}><div className="flex items-center gap-2"><div className="w-4 h-4 rounded-full bg-stone-200 border border-green-700"></div><span className={`text-sm font-bold text-stone-600`}>Fazenda (Nature)</span></div>{theme.id === 'nature' && <Star size={14} className="text-green-700 fill-current" />}</button>
                    </div>
                </div>
            </div>
        );

        const SensoryView = ({ theme }) => (
            <div className="p-4 pb-24">
                <h2 className={`text-xl font-bold mb-2 ${theme.textMain}`}>Avalia√ß√£o Sensorial</h2>
                <p className={`text-sm ${theme.textSec} mb-6`}>Registre suas percep√ß√µes do Caf√© Piat√£.</p>
                <SensoryWheel theme={theme} />
                <div className={`${theme.cardBg} p-4 rounded-xl shadow-sm mb-4`}>
                    <h3 className={`font-bold mb-2 ${theme.textMain}`}>Notas de Prova</h3>
                    <textarea className={`w-full p-3 rounded-lg bg-transparent border ${theme.id === 'dark' ? 'border-zinc-700 text-white' : 'border-gray-200 text-zinc-800'} text-sm focus:outline-none focus:ring-1 focus:ring-red-500`} rows="3" placeholder="Descreva o que sentiu (ex: acidez de maracuj√°, finaliza√ß√£o doce...)"></textarea>
                </div>
            </div>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [currentTheme, setCurrentTheme] = useState(THEMES.classic);
            // Receitas agora come√ßam vazias e s√£o carregadas
            const [recipes, setRecipes] = useState([]);
            const [baristaMode, setBaristaMode] = useState(false);
            const [viewMode, setViewMode] = useState('normal');
            const [isLoading, setIsLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);

            // Hook para carregar √≠cones
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // Hook para ler do Firebase em tempo real
            useEffect(() => {
                setIsLoading(true);
                // "escuta" a cole√ß√£o 'recipes'
                const unsubscribe = db.collection('recipes')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setRecipes(loaded);
                        setIsLoading(false);
                    }, (error) => {
                        console.error("Erro ao ler Firebase:", error);
                        // Se der erro (provavelmente falta de indice ou permissao), apenas para o loading
                        setIsLoading(false);
                    });
                
                return () => unsubscribe();
            }, []);

            const goToRecipe = () => setActiveTab('sensory');

            const handleSaveRecipe = async (newRecipe) => {
                setIsSaving(true);
                try {
                    // Salvar no Firestore
                    await db.collection('recipes').add({
                        ...newRecipe,
                        createdAt: new Date(), // Adiciona timestamp
                        author: 'Moka Clube' 
                    });
                    setViewMode('normal');
                    setActiveTab('home');
                } catch (error) {
                    alert("Erro ao salvar: " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const renderContent = () => {
                if (viewMode === 'admin') return <AdminRecipeForm theme={currentTheme} onSave={handleSaveRecipe} onCancel={() => setViewMode('normal')} isSaving={isSaving} />;
                switch (activeTab) {
                    case 'home': return <FeedView theme={currentTheme} goToRecipe={goToRecipe} recipes={recipes} baristaMode={baristaMode} setView={setViewMode} isLoading={isLoading} />;
                    case 'timer': return <TimerView theme={currentTheme} />;
                    case 'community': return <CommunityView theme={currentTheme} />;
                    case 'sensory': return <SensoryView theme={currentTheme} />;
                    case 'profile': return <ProfileView theme={currentTheme} setTheme={setCurrentTheme} baristaMode={baristaMode} setBaristaMode={setBaristaMode} />;
                    default: return <FeedView theme={currentTheme} recipes={recipes} />;
                }
            };

            return (
                <div className={`${currentTheme.bg} min-h-screen font-sans transition-colors duration-300 max-w-md mx-auto shadow-2xl overflow-hidden relative border-x ${currentTheme.id === 'dark' ? 'border-zinc-800' : 'border-gray-200'}`}>
                    <Header theme={currentTheme} baristaMode={baristaMode} />
                    <main className="min-h-[calc(100vh-140px)]">{renderContent()}</main>
                    {viewMode !== 'admin' && (
                        <nav className={`fixed bottom-0 w-full max-w-md ${currentTheme.navBg} border-t ${currentTheme.id === 'dark' ? 'border-zinc-800' : 'border-gray-200'} flex justify-around py-3 pb-5 px-2 z-50 transition-colors duration-300`}>
                            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'home' ? currentTheme.accentText : 'text-gray-400 hover:text-gray-500'}`}><Coffee size={24} strokeWidth={activeTab === 'home' ? 2.5 : 2} /><span className="text-[10px] font-medium">In√≠cio</span></button>
                            <button onClick={() => setActiveTab('timer')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'timer' ? currentTheme.accentText : 'text-gray-400 hover:text-gray-500'}`}><Timer size={24} strokeWidth={activeTab === 'timer' ? 2.5 : 2} /><span className="text-[10px] font-medium">Timer</span></button>
                            <button onClick={() => setActiveTab('sensory')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'sensory' ? currentTheme.accentText : 'text-gray-400 hover:text-gray-500'}`}><BarChart2 size={24} strokeWidth={activeTab === 'sensory' ? 2.5 : 2} /><span className="text-[10px] font-medium">Avaliar</span></button>
                            <button onClick={() => setActiveTab('community')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'community' ? currentTheme.accentText : 'text-gray-400 hover:text-gray-500'}`}><Users size={24} strokeWidth={activeTab === 'community' ? 2.5 : 2} /><span className="text-[10px] font-medium">Tribo</span></button>
                            <button onClick={() => setActiveTab('profile')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'profile' ? currentTheme.accentText : 'text-gray-400 hover:text-gray-500'}`}><div className={`w-6 h-6 rounded-full overflow-hidden border ${activeTab === 'profile' ? currentTheme.accent : 'border-gray-300 bg-gray-200'} relative`}><div className={`w-full h-full flex items-center justify-center text-[8px] font-bold ${activeTab === 'profile' ? 'bg-transparent text-white' : 'bg-gray-200 text-gray-500'}`}>{baristaMode ? <Shield size={10} className="text-black" /> : 'EU'}</div></div><span className="text-[10px] font-medium">Perfil</span></button>
                        </nav>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>