<!-- 
GITHUB_AI_SUMMARY:
- REFACTOR: Reescrita completa da lógica de Auth para garantir transição de estado imediata (Login Force Update).
- FIX: Ícones convertidos para SVG inline para eliminar dependências de scripts externos e erros de CORS.
- FEAT: Modo Demo/Convidado aprimorado para testes rápidos sem backend.
- UI: Tema Dark Mode consolidado como padrão.
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moka Clube App</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            safelist: [
                'bg-zinc-900', 'bg-zinc-800', 'bg-black', 'bg-zinc-950',
                'text-white', 'text-zinc-400', 'text-zinc-500', 'text-zinc-300',
                'bg-yellow-500', 'text-yellow-500', 'border-yellow-500', 'bg-yellow-400', 'text-yellow-400',
                'border-zinc-700', 'border-zinc-800',
                'fill-current', 'animate-pulse', 'border-current',
                'bg-red-600', 'text-red-600'
            ],
            theme: {
                extend: {
                    colors: {
                        moka: '#DC2626',
                    }
                }
            }
        }
    </script>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { background-color: #18181b; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useRef } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDnElIN9JV7OtApqh4orYVXjdpr41jtyHc",
            authDomain: "moka-clube-app.firebaseapp.com",
            projectId: "moka-clube-app",
            storageBucket: "moka-clube-app.firebasestorage.app",
            messagingSenderId: "921502412834",
            appId: "1:921502412834:web:f72730a5f7444cb440da7b"
        };

        let db = null;
        let auth = null;

        try {
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("Firebase ligado.");
            }
        } catch (error) {
            console.error("Erro Firebase:", error);
        }

        // --- TEMA ---
        const THEME = {
            id: 'dark', bg: 'bg-zinc-900', cardBg: 'bg-zinc-800', textMain: 'text-white', textSec: 'text-zinc-400',
            accent: 'bg-yellow-500', accentText: 'text-yellow-500', navBg: 'bg-zinc-900', headerBg: 'bg-black', headerText: 'text-white', border: 'border-zinc-700'
        };

        // --- ÍCONES SVG ---
        const ICON_PATHS = {
            'coffee': <path d="M17 8h1a4 4 0 1 1 0 8h-1 M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z M6 1v3 M10 1v3 M14 1v3" />,
            'timer': <path d="M10 2h4 M12 14v-4 M4 13a8 8 0 0 1 8-7 8 8 0 1 1-8 7 M22 13a18.3 18.3 0 0 1-4 6" />, 
            'users': <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />,
            'plus-circle': <g><circle cx="12" cy="12" r="10" /><path d="M8 12h8 M12 8v8" /></g>,
            'heart': <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
            'droplet': <path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.74l-4-3.26-4 3.26c-2 1.84-3 3.74-3 5.74a7 7 0 0 0 7 7Z" />,
            'thermometer': <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0Z" />,
            'chevron-right': <path d="m9 18 6-6-6-6" />,
            'play': <polygon points="5 3 19 12 5 21 5 3" />,
            'play-circle': <g><circle cx="12" cy="12" r="10" /><polygon points="10 8 16 12 10 16 10 8" /></g>,
            'pause': <g><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></g>,
            'rotate-ccw': <g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></g>,
            'search': <g><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></g>,
            'award': <g><circle cx="12" cy="8" r="7" /><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" /></g>,
            'settings': <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></g>,
            'star': <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />,
            'zap': <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            'map-pin': <g><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></g>,
            'bar-chart-2': <g><line x1="18" x2="18" y1="20" y2="10" /><line x1="12" x2="12" y1="20" y2="4" /><line x1="6" x2="6" y1="20" y2="14" /></g>,
            'youtube': <g><path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17" /><path d="m10 15 5-3-5-3z" /></g>,
            'save': <g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></g>,
            'shield': <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />,
            'x': <g><path d="M18 6 6 18" /><path d="m6 6 12 12" /></g>,
            'chef-hat': <g><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 9.08 0A5.11 5.11 0 0 1 18.59 6 4 4 0 0 1 18 13.87V21H6Z" /><line x1="6" x2="18" y1="17" y2="17" /></g>,
            'container': <g><path d="M20.9 19.8A2 2 0 0 1 19 21H5a2 2 0 0 1-1.9-1.2l-2.4-7.2A2 2 0 0 1 2.6 10H21.4a2 2 0 0 1 1.9 2.6Z" /><path d="M10 21V10" /><path d="M14 21V10" /></g>,
            'arrow-down-circle': <g><circle cx="12" cy="12" r="10" /><polyline points="8 12 12 16 16 12" /><line x1="12" x2="12" y1="8" y2="16" /></g>,
            'flask-conical': <g><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" /><line x1="8.5" x2="15.5" y1="2" y2="2" /><path d="M8.5 2h7" /></g>,
            'triangle': <path d="M13.73 21a2 2 0 0 1-3.46 0l-8-14A2 2 0 0 1 4 4h16a2 2 0 0 1 1.73 3l-8 14z" />,
            'trash': <g><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></g>,
            'edit': <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
            'send': <g><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></g>,
            'log-out': <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></g>,
            'mail': <g><rect width="20" height="16" x="2" y="4" rx="2" /><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" /></g>,
            'lock': <g><rect width="18" height="11" x="3" y="11" rx="2" y="11" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></g>,
            'user': <g><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></g>,
            'calendar': <g><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></g>,
            'phone': <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
        };

        const Icon = ({ name, size = 24, className, fill = "none", ...props }) => {
            const content = ICON_PATHS[name];
            if (!content) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {content}
                </svg>
            );
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) { return { hasError: true, error }; }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center text-white bg-red-900 h-screen flex flex-col items-center justify-center">
                            <h2 className="text-2xl font-bold mb-2">Ops! Algo deu errado.</h2>
                            <button onClick={() => window.location.reload()} className="bg-white text-red-900 px-4 py-2 rounded font-bold">Recarregar App</button>
                            <pre className="mt-4 text-[10px] text-left bg-black/50 p-4 rounded w-full overflow-auto max-w-sm">{this.state.error.toString()}</pre>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- AUTH VIEW ---
        const AuthView = ({ onLoginSuccess }) => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [formData, setFormData] = useState({ name: '', email: '', password: '', phone: '', birthdate: '' });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    if (!auth) throw new Error("Sistema de login indisponível.");
                    
                    if (isRegistering) {
                        const cred = await auth.createUserWithEmailAndPassword(formData.email, formData.password);
                        if (db) {
                            await db.collection('users').doc(cred.user.uid).set({
                                name: formData.name, email: formData.email, phone: formData.phone, 
                                birthdate: formData.birthdate, createdAt: new Date()
                            });
                        }
                        await cred.user.updateProfile({ displayName: formData.name });
                        onLoginSuccess(cred.user);
                    } else {
                        const cred = await auth.signInWithEmailAndPassword(formData.email, formData.password);
                        onLoginSuccess(cred.user);
                    }
                } catch (error) {
                    alert("Erro: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleDemo = () => {
                onLoginSuccess({ displayName: "Visitante Demo", email: "demo@moka.com.br", uid: "demo-123" });
            };

            return (
                <div className="min-h-screen bg-zinc-900 flex flex-col items-center justify-center p-6 text-white">
                    <div className="w-full max-w-sm text-center mb-8">
                        <div className="w-20 h-20 bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-yellow-500">
                            <Icon name="coffee" size={40} className="text-white" />
                        </div>
                        <h1 className="text-2xl font-bold tracking-wider">MOKA CLUBE</h1>
                        <p className="text-zinc-500 text-sm">Entre para a comunidade do café.</p>
                    </div>

                    <form onSubmit={handleSubmit} className="w-full max-w-sm space-y-4">
                        {isRegistering && <div className="bg-zinc-800 p-3 rounded-lg border border-zinc-700 flex items-center gap-3"><Icon name="user" className="text-zinc-500" /><input type="text" placeholder="Nome Completo" className="bg-transparent w-full outline-none text-sm" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required /></div>}
                        <div className="bg-zinc-800 p-3 rounded-lg border border-zinc-700 flex items-center gap-3"><Icon name="mail" className="text-zinc-500" /><input type="email" placeholder="E-mail" className="bg-transparent w-full outline-none text-sm" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required /></div>
                        <div className="bg-zinc-800 p-3 rounded-lg border border-zinc-700 flex items-center gap-3"><Icon name="lock" className="text-zinc-500" /><input type="password" placeholder="Senha" className="bg-transparent w-full outline-none text-sm" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required /></div>
                        {isRegistering && <><div className="bg-zinc-800 p-3 rounded-lg border border-zinc-700 flex items-center gap-3"><Icon name="phone" className="text-zinc-500" /><input type="tel" placeholder="Celular" className="bg-transparent w-full outline-none text-sm" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} required /></div><div className="bg-zinc-800 p-3 rounded-lg border border-zinc-700 flex items-center gap-3"><Icon name="calendar" className="text-zinc-500" /><input type="date" className="bg-transparent w-full outline-none text-sm text-zinc-400" value={formData.birthdate} onChange={e => setFormData({...formData, birthdate: e.target.value})} required /></div></>}
                        <button type="submit" disabled={isLoading} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors flex justify-center items-center">{isLoading ? "Carregando..." : (isRegistering ? "Criar Conta" : "Entrar")}</button>
                    </form>
                    <button onClick={handleDemo} className="mt-4 text-xs text-zinc-500 underline">Entrar como Convidado</button>
                    <div className="mt-6 text-center text-sm"><button onClick={() => setIsRegistering(!isRegistering)} className="text-zinc-400 hover:text-white underline">{isRegistering ? "Já tem conta? Faça Login" : "Não tem conta? Cadastre-se"}</button></div>
                </div>
            );
        };

        // --- DADOS ---
        const BREW_METHODS = [
            { name: "Hario V60", icon: "coffee", defaultTime: 180 },
            { name: "Prensa Francesa", icon: "container", defaultTime: 240 },
            { name: "Aeropress", icon: "arrow-down-circle", defaultTime: 120 },
            { name: "Chemex", icon: "flask-conical", defaultTime: 210 },
            { name: "Koar", icon: "triangle", defaultTime: 180 },
        ];

        const BADGES = [
            { id: 1, name: "Pioneiro do Norte", iconName: "map-pin", desc: "Provou 5 cafés do PR", earned: true },
            { id: 2, name: "Alquimista V60", iconName: "coffee", desc: "10 receitas criadas", earned: true },
            { id: 3, name: "Caçador de Acidez", iconName: "zap", desc: "Avaliou 5 cafés cítricos", earned: false },
            { id: 4, name: "Mestre da Prensa", iconName: "timer", desc: "Usou timer 50x", earned: false },
        ];

        const INITIAL_OFFICIAL_RECIPES = [
            {
                id: 'static-1',
                title: "Catuaí Vermelho - Norte Pioneiro",
                region: "Norte Pioneiro, PR",
                method: "Hario V60",
                ratio: "1:16",
                notes: "Notas de caramelo, acidez cítrica média.",
                author: "Moka Clube",
                likes: 342,
                difficulty: "Média",
                temp: "93°C",
                videoId: "w2-S7Ww2rSc",
                steps: [
                    { title: "Início", text: "Hidrate o filtro e adicione 20g de café." },
                    { title: "00:00", text: "Inicie o timer. Faça o bloom com 50g de água." },
                    { title: "00:30", text: "Despeje suavemente até atingir 200g." },
                    { title: "01:30", text: "Complete até 320g e aguarde finalizar." }
                ]
            }
        ];

        const COMMUNITY_RECIPES = [
            { id: 101, title: "Aeropress Invertida Power", coffee: "Moka da Matina", author: "Ricardo S.", method: "Aeropress", likes: 56, time_ago: "2h atrás", desc: "Uma receita pra quem gosta de corpo alto." },
            { id: 102, title: "V60 Gelado (Japanese Style)", coffee: "Etiópia Brasileiro", author: "Ana Clara", method: "V60", likes: 89, time_ago: "5h atrás", desc: "Substituí 40% da água por gelo na jarra." }
        ];

        // --- AUXILIARES ---
        const getYoutubeEmbedUrl = (videoId) => `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        const getYoutubeThumbnail = (videoId) => `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        const extractVideoId = (url) => {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        // --- COMPONENTES ---

        const YouTubePlayer = ({ videoId }) => {
            const [isPlaying, setIsPlaying] = useState(false);
            if (!videoId) return null;
            if (isPlaying) {
                return (
                    <div className="w-full aspect-video bg-black rounded-xl overflow-hidden shadow-lg animate-fade-in">
                        <iframe width="100%" height="100%" src={getYoutubeEmbedUrl(videoId)} frameBorder="0" allow="autoplay; encrypted-media" allowFullScreen></iframe>
                    </div>
                );
            }
            return (
                <div className="w-full aspect-video bg-zinc-800 rounded-xl overflow-hidden shadow-lg relative group cursor-pointer" onClick={() => setIsPlaying(true)}>
                    <img src={getYoutubeThumbnail(videoId)} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" alt="Video Thumbnail" />
                    <div className="absolute inset-0 flex items-center justify-center">
                        <div className="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center shadow-xl group-hover:scale-110 transition-transform">
                            <Icon name="play" size={32} className="text-white ml-1 fill-current" />
                        </div>
                    </div>
                </div>
            );
        };

        const ReviewSection = ({ recipeId, user }) => {
            const [reviews, setReviews] = useState([]);
            const [newRating, setNewRating] = useState(0);
            const [newComment, setNewComment] = useState("");
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (!recipeId || recipeId.startsWith('static') || !db) return;
                const unsubscribe = db.collection('recipes').doc(recipeId).collection('reviews')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        setReviews(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }, err => console.log("Erro reviews:", err));
                return () => unsubscribe();
            }, [recipeId]);

            const handleSubmit = async () => {
                if (newRating === 0) return alert("Por favor, selecione uma nota.");
                if (!recipeId || recipeId.startsWith('static')) return alert("Receitas de exemplo não aceitam comentários reais.");
                if (!db) return alert("Modo offline: não é possível salvar.");
                setIsSubmitting(true);
                try {
                    await db.collection('recipes').doc(recipeId).collection('reviews').add({
                        author: user.displayName || "Usuário", 
                        rating: newRating, 
                        comment: newComment, 
                        createdAt: new Date(),
                        userId: user.uid
                    });
                    setNewComment(""); setNewRating(0);
                } catch (error) { console.error(error); alert("Erro ao enviar review."); } finally { setIsSubmitting(false); }
            };

            return (
                <div className="mt-6 pt-6 border-t border-zinc-700">
                    <h4 className="font-bold text-lg mb-4 text-white flex items-center gap-2"><Icon name="star" size={20} className="text-yellow-500 fill-current" /> Avaliações</h4>
                    <div className="bg-zinc-800/50 p-4 rounded-xl mb-6 border border-zinc-700">
                        <div className="flex justify-center gap-2 mb-3">
                            {[1, 2, 3, 4, 5].map(star => (
                                <button key={star} onClick={() => setNewRating(star)} className="focus:outline-none hover:scale-110 transition-transform">
                                    <Icon name="star" size={28} className={star <= newRating ? "text-yellow-500 fill-current" : "text-zinc-600"} />
                                </button>
                            ))}
                        </div>
                        <textarea className="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 text-sm text-white focus:border-yellow-500 outline-none resize-none mb-2" rows="2" placeholder="O que achou desta receita?" value={newComment} onChange={e => setNewComment(e.target.value)}></textarea>
                        <button onClick={handleSubmit} disabled={isSubmitting} className="w-full bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-2 rounded-lg text-xs uppercase tracking-wider flex items-center justify-center gap-2">{isSubmitting ? "Enviando..." : <><Icon name="send" size={14} /> Publicar</>}</button>
                    </div>
                    <div className="space-y-4">
                        {reviews.length === 0 && <p className="text-center text-zinc-500 text-sm">Seja o primeiro a avaliar!</p>}
                        {reviews.map(review => (
                            <div key={review.id} className="border-b border-zinc-800 pb-3 last:border-0">
                                <div className="flex justify-between items-start mb-1"><span className="font-bold text-sm text-white">{review.author}</span><div className="flex text-yellow-500">{[...Array(Number(review.rating) || 0)].map((_, i) => <Icon key={i} name="star" size={12} className="fill-current" />)}</div></div>
                                <p className="text-zinc-400 text-xs leading-relaxed">{review.comment}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const RecipeDetailModal = ({ recipe, onClose, user }) => {
            if (!recipe) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in p-0 sm:p-4">
                    <div className={`${THEME.cardBg} w-full max-w-md h-[90vh] sm:h-auto sm:max-h-[90vh] rounded-t-2xl sm:rounded-2xl flex flex-col shadow-2xl overflow-hidden border ${THEME.border}`}>
                        <div className={`flex justify-between items-center p-4 border-b ${THEME.border} bg-zinc-800 sticky top-0 z-10`}>
                            <div><h3 className={`font-bold text-lg ${THEME.textMain}`}>{recipe.title}</h3><p className={`text-xs ${THEME.textSec}`}>por {recipe.author}</p></div>
                            <button onClick={onClose} className={`p-2 rounded-full hover:bg-white/10 ${THEME.textMain}`}><Icon name="x" size={20} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6">
                            <YouTubePlayer videoId={recipe.videoId} />
                            <div className="grid grid-cols-3 gap-2">
                                <div className={`p-3 rounded-lg text-center border ${THEME.border}`}><div className={`mx-auto mb-1 ${THEME.accentText} flex justify-center`}><Icon name="droplet" size={16} /></div><span className={`block text-xs font-bold ${THEME.textMain}`}>{recipe.ratio || '1:16'}</span><span className="text-[10px] text-gray-400">Ratio</span></div>
                                <div className={`p-3 rounded-lg text-center border ${THEME.border}`}><div className={`mx-auto mb-1 ${THEME.accentText} flex justify-center`}><Icon name="thermometer" size={16} /></div><span className={`block text-xs font-bold ${THEME.textMain}`}>{recipe.temp || '93°C'}</span><span className="text-[10px] text-gray-400">Temp</span></div>
                                <div className={`p-3 rounded-lg text-center border ${THEME.border}`}><div className={`mx-auto mb-1 ${THEME.accentText} flex justify-center`}><Icon name="chef-hat" size={16} /></div><span className={`block text-xs font-bold ${THEME.textMain}`}>{recipe.difficulty || 'Fácil'}</span><span className="text-[10px] text-gray-400">Nível</span></div>
                            </div>
                            <div className={`p-4 rounded-lg bg-zinc-900`}>
                                <h4 className={`text-sm font-bold mb-2 ${THEME.textMain}`}>Notas do Barista</h4>
                                <p className={`text-sm ${THEME.textSec} italic`}>"{recipe.notes || recipe.desc || 'Sem notas.'}"</p>
                            </div>
                            <div>
                                <h4 className={`text-sm font-bold mb-3 ${THEME.textMain}`}>Passo a Passo</h4>
                                <div className="space-y-4 relative pl-4 border-l-2 border-zinc-700">
                                    {recipe.steps && recipe.steps.length > 0 ? recipe.steps.map((step, idx) => (
                                        <div key={idx} className="relative">
                                            <div className={`absolute -left-[21px] top-0 w-4 h-4 rounded-full ${THEME.accent} border-2 border-white`}></div>
                                            <span className={`text-xs font-bold ${THEME.accentText} uppercase tracking-wider block mb-1`}>{step.title}</span>
                                            <p className={`text-sm ${THEME.textMain}`}>{step.text || step.instructions}</p>
                                        </div>
                                    )) : <p className={`text-sm ${THEME.textSec}`}>Siga o método padrão {recipe.method}.</p>}
                                </div>
                            </div>
                            <ReviewSection recipeId={recipe.id} user={user} />
                        </div>
                    </div>
                </div>
            );
        };

        const RecipeSearchResultsModal = ({ recipes, onClose, onViewDetail }) => {
            if (!recipes) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in p-0 sm:p-4">
                    <div className={`${THEME.cardBg} w-full max-w-md h-[80vh] sm:h-auto sm:max-h-[80vh] rounded-t-2xl sm:rounded-2xl flex flex-col shadow-2xl overflow-hidden border ${THEME.border}`}>
                        <div className={`flex justify-between items-center p-4 border-b ${THEME.border} bg-zinc-800`}>
                            <h3 className={`font-bold text-lg ${THEME.textMain}`}>Receitas Encontradas</h3>
                            <button onClick={onClose} className={`p-2 rounded-full hover:bg-white/10 ${THEME.textMain}`}><Icon name="x" size={20} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {recipes.length === 0 ? <p className="text-center text-zinc-500 py-8">Nenhuma receita encontrada para este café.</p> : recipes.map(recipe => (
                                <div key={recipe.id} onClick={() => { onClose(); onViewDetail(recipe); }} className="bg-zinc-900 p-3 rounded-lg border border-zinc-700 cursor-pointer hover:bg-zinc-800">
                                    <div className="flex justify-between"><span className="font-bold text-sm text-white">{recipe.title}</span><span className="text-xs text-yellow-500 font-bold">{recipe.method}</span></div>
                                    <p className="text-xs text-zinc-400 mt-1">por {recipe.author}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const AdminRecipeForm = ({ onSave, onCancel, isSaving, initialData }) => {
            const [formData, setFormData] = useState({ title: '', region: '', method: 'Hario V60', ratio: '1:16', temp: '93°C', notes: '', videoUrl: '', steps: [{ title: 'Início', text: '' }] });
            useEffect(() => {
                if (initialData) {
                    const videoUrl = initialData.videoId ? `https://youtube.com/watch?v=${initialData.videoId}` : '';
                    setFormData({ ...initialData, videoUrl, steps: initialData.steps || [] });
                }
            }, [initialData]);
            const handleStepChange = (index, field, value) => { const newSteps = [...formData.steps]; newSteps[index][field] = value; setFormData({ ...formData, steps: newSteps }); };
            const addStep = () => { setFormData({ ...formData, steps: [...formData.steps, { title: '', text: '' }] }); };
            const removeStep = (index) => { setFormData({ ...formData, steps: formData.steps.filter((_, i) => i !== index) }); };
            const handleSubmit = () => {
                const videoId = formData.videoUrl ? extractVideoId(formData.videoUrl) : '';
                onSave({ ...formData, videoId, author: 'Moka Clube', likes: initialData ? initialData.likes : 0 });
            };
            return (
                <div className={`p-4 ${THEME.bg} min-h-screen pb-24`}>
                    <div className="flex items-center gap-2 mb-6"><div className={THEME.accentText}><Icon name="shield" size={24} /></div><h2 className={`text-xl font-bold ${THEME.textMain}`}>{initialData ? 'Editar Receita' : 'Nova Receita Oficial'}</h2></div>
                    <div className={`${THEME.cardBg} p-5 rounded-xl border ${THEME.border} space-y-4`}>
                        <div><label className={`block text-xs font-bold ${THEME.textSec} mb-1 uppercase`}>Nome do Café</label><input type="text" className={`w-full p-2 rounded border bg-zinc-900 border-zinc-700 text-white text-sm`} placeholder="Ex: Catuaí..." value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} /></div>
                        <div><label className={`block text-xs font-bold ${THEME.textSec} mb-1 uppercase`}>Região</label><input type="text" className={`w-full p-2 rounded border bg-zinc-900 border-zinc-700 text-white text-sm`} placeholder="Ex: Chapada..." value={formData.region} onChange={e => setFormData({...formData, region: e.target.value})} /></div>
                        <div className="flex gap-2"><div className="flex-1"><label className={`block text-xs font-bold ${THEME.textSec} mb-1 uppercase`}>Método</label><select className={`w-full p-2 rounded border bg-zinc-900 border-zinc-700 text-white text-sm`} value={formData.method} onChange={e => setFormData({...formData, method: e.target.value})}>{BREW_METHODS.map(m => <option key={m.name} value={m.name}>{m.name}</option>)}</select></div><div className="w-1/3"><label className={`block text-xs font-bold ${THEME.textSec} mb-1 uppercase`}>Temp.</label><input type="text" className={`w-full p-2 rounded border bg-zinc-900 border-zinc-700 text-white text-sm`} value={formData.temp} onChange={e => setFormData({...formData, temp: e.target.value})} /></div></div>
                        <div><label className={`block text-xs font-bold ${THEME.textSec} mb-1 uppercase flex items-center gap-1`}><Icon name="youtube" size={14} /> Link Vídeo</label><input type="text" className={`w-full p-2 rounded border bg-zinc-900 border-zinc-700 text-white text-sm`} placeholder="YouTube Link" value={formData.videoUrl} onChange={e => setFormData({...formData, videoUrl: e.target.value})} /></div>
                        <div><label className={`block text-xs font-bold ${THEME.textSec} mb-1 uppercase`}>Notas</label><textarea className={`w-full p-2 rounded border bg-zinc-900 border-zinc-700 text-white text-sm`} rows="3" value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})}></textarea></div>
                        <div className="pt-2 border-t border-zinc-700"><label className={`block text-xs font-bold ${THEME.textSec} mb-3 uppercase`}>Passo a Passo</label>{formData.steps.map((step, index) => (<div key={index} className="flex gap-2 mb-2 items-start"><div className="w-1/4"><input type="text" className="w-full p-2 rounded border bg-zinc-900 border-zinc-700 text-white text-xs" placeholder="Tempo" value={step.title} onChange={(e) => handleStepChange(index, 'title', e.target.value)} /></div><div className="flex-1"><input type="text" className="w-full p-2 rounded border bg-zinc-900 border-zinc-700 text-white text-xs" placeholder="Instrução" value={step.text} onChange={(e) => handleStepChange(index, 'text', e.target.value)} /></div><button onClick={() => removeStep(index)} className="p-2 text-red-500 hover:text-red-400"><Icon name="trash" size={16} /></button></div>))}<button onClick={addStep} className={`mt-2 w-full py-2 border border-dashed border-zinc-600 text-zinc-400 rounded-lg text-xs font-bold hover:bg-zinc-800`}>+ ADICIONAR PASSO</button></div>
                        <div className="flex gap-3 pt-4"><button onClick={onCancel} className={`flex-1 py-3 rounded-lg font-bold text-sm ${THEME.textSec} border border-transparent`}>Cancelar</button><button onClick={handleSubmit} disabled={isSaving} className={`flex-1 py-3 rounded-lg font-bold text-sm text-black ${THEME.accent} shadow-md flex items-center justify-center gap-2 hover:brightness-110`}>{isSaving ? '...' : 'Salvar Receita'}</button></div>
                    </div>
                </div>
            );
        };

        const SensoryEvaluation = ({ onFindRecipes, user }) => {
            const [view, setView] = useState('list'); // 'list' | 'form'
            const [evaluations, setEvaluations] = useState([]);
            const [formData, setFormData] = useState({ 
                coffeeName: '', rating: 0, notes: '', 
                attributes: { acidez: 3, docura: 4, corpo: 2, amargor: 1, finalizacao: 3 } 
            });

            useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('evaluations')
                    .where('userId', '==', user.uid)
                    .onSnapshot(snap => {
                        const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        data.sort((a, b) => b.createdAt - a.createdAt);
                        setEvaluations(data);
                    }, err => console.log("Erro ao carregar avaliações:", err));
                return () => unsub();
            }, [user]);

            const handleEdit = (ev) => {
                setFormData(ev);
                setView('form');
            };

            const handleSave = async () => {
                if (!formData.coffeeName) return alert("Digite o nome do café");
                if (!db) return alert("Modo offline.");
                try {
                    if (formData.id) {
                        await db.collection('evaluations').doc(formData.id).update({
                            coffeeName: formData.coffeeName, rating: formData.rating, notes: formData.notes, attributes: formData.attributes
                        });
                    } else {
                        await db.collection('evaluations').add({ 
                            ...formData, userId: user.uid, createdAt: new Date() 
                        });
                    }
                    setView('list');
                    setFormData({ coffeeName: '', rating: 0, notes: '', attributes: { acidez: 3, docura: 4, corpo: 2, amargor: 1, finalizacao: 3 } });
                } catch(e) { alert("Erro ao salvar: " + e.message); }
            };

            const calculatePoints = (attrs) => {
                const keys = Object.keys(attrs);
                const total = keys.length;
                const centerX = 100, centerY = 100, radius = 80;
                return keys.map((key, i) => {
                    const value = attrs[key];
                    const angle = (Math.PI * 2 * i) / total - Math.PI / 2;
                    const r = (value / 5) * radius;
                    const x = centerX + r * Math.cos(angle);
                    const y = centerY + r * Math.sin(angle);
                    return `${x},${y}`;
                }).join(' ');
            };

            if (view === 'list') {
                return (
                    <div className="p-4 pb-24">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className={`text-xl font-bold ${THEME.textMain}`}>Meus Cafés</h2>
                            <button onClick={() => { setFormData({ coffeeName: '', rating: 0, notes: '', attributes: { acidez: 3, docura: 4, corpo: 2, amargor: 1, finalizacao: 3 } }); setView('form'); }} className={`${THEME.headerBg} ${THEME.headerText} px-4 py-2 rounded-full shadow-lg text-xs font-bold flex items-center gap-2 border border-zinc-700`}><Icon name="plus-circle" size={16} /> NOVO</button>
                        </div>
                        {evaluations.length === 0 ? <div className="text-center py-10 text-zinc-500"><Icon name="coffee" size={48} className="mx-auto mb-2 opacity-20" /><p>Nenhuma avaliação ainda.</p></div> : 
                            <div className="space-y-4">{evaluations.map(ev => (
                                <div key={ev.id} onClick={() => handleEdit(ev)} className={`${THEME.cardBg} p-4 rounded-xl border ${THEME.border} shadow-sm cursor-pointer hover:bg-zinc-700/50 transition-colors relative group`}>
                                    <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity bg-zinc-900 p-1.5 rounded-full shadow-md border border-zinc-700"><Icon name="edit" size={12} className="text-zinc-400" /></div>
                                    <div className="flex justify-between items-start mb-2"><h3 className="font-bold text-white text-lg">{ev.coffeeName}</h3><div className="flex text-yellow-500">{[...Array(Number(ev.rating)||0)].map((_, i) => <Icon key={i} name="star" size={14} className="fill-current" />)}</div></div>
                                    <p className="text-xs text-zinc-400 mb-3 line-clamp-2">{ev.notes}</p>
                                    <div className="flex gap-3 mt-3 items-center">
                                        <div className="flex-shrink-0"><svg width="50" height="50" viewBox="0 0 200 200" className="opacity-60"><circle cx="100" cy="100" r="80" fill="none" stroke="#333" strokeWidth="2" opacity="0.5" /><polygon points={calculatePoints(ev.attributes)} fill="rgba(234, 179, 8, 0.4)" stroke="#EAB308" strokeWidth="4" /></svg></div>
                                        <div className="flex-1 grid grid-cols-3 gap-x-2 gap-y-1 text-[10px] text-zinc-400">
                                            <div className="flex flex-col"><span className="text-zinc-600 text-[9px] uppercase tracking-wider">Acidez</span><span className="font-bold text-zinc-300">{ev.attributes.acidez}/5</span></div>
                                            <div className="flex flex-col"><span className="text-zinc-600 text-[9px] uppercase tracking-wider">Doçura</span><span className="font-bold text-zinc-300">{ev.attributes.docura}/5</span></div>
                                            <div className="flex flex-col"><span className="text-zinc-600 text-[9px] uppercase tracking-wider">Corpo</span><span className="font-bold text-zinc-300">{ev.attributes.corpo}/5</span></div>
                                            <div className="flex flex-col"><span className="text-zinc-600 text-[9px] uppercase tracking-wider">Amargor</span><span className="font-bold text-zinc-300">{ev.attributes.amargor}/5</span></div>
                                            <div className="flex flex-col"><span className="text-zinc-600 text-[9px] uppercase tracking-wider">Final</span><span className="font-bold text-zinc-300">{ev.attributes.finalizacao}/5</span></div>
                                        </div>
                                    </div>
                                </div>
                            ))}</div>
                        }
                    </div>
                );
            }
            return (
                <div className="p-4 pb-24 animate-fade-in">
                    <div className="flex items-center gap-2 mb-4"><button onClick={() => { setView('list'); setFormData({ coffeeName: '', rating: 0, notes: '', attributes: { acidez: 3, docura: 4, corpo: 2, amargor: 1, finalizacao: 3 } }); }}><Icon name="chevron-right" size={24} className="rotate-180 text-zinc-400" /></button><h2 className={`text-xl font-bold ${THEME.textMain}`}>{formData.id ? 'Editar Avaliação' : 'Avaliar Café'}</h2></div>
                    <div className={`${THEME.cardBg} p-4 rounded-xl border ${THEME.border} space-y-6`}>
                        <div><label className="block text-xs font-bold text-zinc-400 uppercase mb-1">Nome do Café</label><div className="flex gap-2"><input type="text" className="flex-1 p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white text-sm" placeholder="Ex: Catuaí Amarelo" value={formData.coffeeName} onChange={e => setFormData({...formData, coffeeName: e.target.value})} />{formData.coffeeName && <button onClick={() => onFindRecipes(formData.coffeeName)} className="bg-yellow-500 text-black p-3 rounded-lg font-bold" title="Procurar receitas"><Icon name="search" size={20} /></button>}</div></div>
                        <div className="flex flex-col items-center"><div className="relative w-48 h-48 mb-4"><svg width="200" height="200" viewBox="0 0 200 200">{[1, 2, 3, 4, 5].map(step => <circle key={step} cx="100" cy="100" r={(step/5)*80} fill="none" stroke="#333" strokeWidth="1" />)}<polygon points={calculatePoints(formData.attributes)} fill="rgba(234, 179, 8, 0.2)" stroke="#EAB308" strokeWidth="2" /></svg><div className="absolute top-0 left-1/2 -translate-x-1/2 text-[10px] font-bold text-zinc-500">ACIDEZ</div><div className="absolute bottom-0 left-1/2 -translate-x-1/2 text-[10px] font-bold text-zinc-500">CORPO</div><div className="absolute right-0 top-1/3 text-[10px] font-bold text-zinc-500">DOÇURA</div><div className="absolute left-0 top-1/3 text-[10px] font-bold text-zinc-500">FINAL</div><div className="absolute right-2 bottom-1/4 text-[10px] font-bold text-zinc-500">AMARGOR</div></div><div className="w-full space-y-3">{Object.entries(formData.attributes).map(([key, val]) => (<div key={key} className="flex items-center gap-2 text-xs"><span className="w-16 capitalize font-medium text-zinc-400">{key}</span><input type="range" min="1" max="5" step="1" value={val} onChange={(e) => setFormData({...formData, attributes: { ...formData.attributes, [key]: parseInt(e.target.value) }})} className="w-full h-1.5 rounded-lg appearance-none cursor-pointer bg-zinc-700 accent-yellow-500" /><span className="w-4 text-center font-bold text-white">{val}</span></div>))}</div></div>
                        <div className="border-t border-zinc-700 pt-4"><label className="block text-xs font-bold text-zinc-400 uppercase mb-2">Sua Nota</label><div className="flex gap-2 mb-4">{[1, 2, 3, 4, 5].map(star => (<button key={star} onClick={() => setFormData({...formData, rating: star})}><Icon name="star" size={32} className={star <= formData.rating ? "text-yellow-500 fill-current" : "text-zinc-700"} /></button>))}</div><textarea className="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white text-sm" rows="3" placeholder="Notas de prova..." value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})}></textarea></div>
                        <button onClick={handleSave} className={`w-full py-3 rounded-lg font-bold text-black ${THEME.accent} shadow-lg hover:brightness-110`}>Salvar Avaliação</button>
                    </div>
                </div>
            );
        };

        const Header = ({ baristaMode }) => (
            <header className={`${THEME.headerBg} ${THEME.headerText} p-4 sticky top-0 z-50 shadow-md flex justify-between items-center transition-colors duration-300 border-b border-zinc-800`}>
                <div className="flex items-center gap-2">
                    <div className={`${THEME.accent} p-1.5 rounded-lg`}><Icon name="coffee" size={20} className="text-black" /></div>
                    <h1 className="font-bold text-lg tracking-wider">MOKA <span className="font-light opacity-70">APP</span></h1>
                </div>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border border-zinc-700 bg-zinc-800`}>
                    {baristaMode ? <Icon name="shield" size={14} className="text-yellow-400" /> : "MC"}
                </div>
            </header>
        );

        const RecipeCard = ({ recipe, isOfficial, onViewDetail, baristaMode, onEdit }) => {
            const [likes, setLikes] = useState(recipe.likes || 0);
            const [liked, setLiked] = useState(false);
            const handleLike = async (e) => {
                e.stopPropagation();
                if (liked) return;
                setLikes(prev => prev + 1);
                setLiked(true);
                if (isOfficial && recipe.id && !recipe.id.startsWith('static')) {
                    try { await db.collection('recipes').doc(recipe.id).update({ likes: firebase.firestore.FieldValue.increment(1) }); } catch(e) {}
                }
            };
            return (
                <div onClick={() => onViewDetail(recipe)} className={`cursor-pointer ${THEME.cardBg} rounded-xl shadow-sm border ${THEME.border} overflow-hidden mb-4 hover:shadow-md transition-all relative group`}>
                    {isOfficial && baristaMode && (
                        <button 
                            onClick={(e) => { e.stopPropagation(); onEdit(recipe); }}
                            className="absolute top-2 right-2 z-10 p-2 bg-yellow-500 rounded-full shadow-lg text-black hover:scale-110 transition-transform"
                        >
                            <Icon name="edit" size={16} />
                        </button>
                    )}
                    {/* Exibe Thumbnail na lista também */}
                    {isOfficial && recipe.videoId && (
                        <div className="w-full aspect-video bg-zinc-800 relative">
                            <img src={getYoutubeThumbnail(recipe.videoId)} className="w-full h-full object-cover opacity-90" alt="Video" />
                            <div className="absolute inset-0 flex items-center justify-center">
                                <div className="w-10 h-10 bg-black/50 rounded-full flex items-center justify-center backdrop-blur-sm">
                                    <Icon name="play" size={20} className="text-white ml-1 fill-current" />
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="p-4">
                        <div className="flex justify-between items-start mb-2">
                            <span className={`text-xs font-bold px-2 py-1 rounded-full ${isOfficial ? `${THEME.headerBg} ${THEME.headerText} border border-zinc-700` : 'bg-zinc-700 text-zinc-300'}`}>{recipe.method}</span>
                            <button onClick={handleLike} className={`flex items-center gap-1 ${liked ? 'text-red-500' : THEME.textSec} text-sm`}><Icon name="heart" size={14} className={liked ? "fill-current" : ""} /><span>{likes}</span></button>
                        </div>
                        <h3 className={`font-bold text-lg ${THEME.textMain} leading-tight mb-1`}>{recipe.title}</h3>
                        {isOfficial ? <p className={`text-xs ${THEME.accentText} font-bold mb-2 uppercase tracking-wide`}>{recipe.region}</p> : <p className={`text-xs ${THEME.textSec} mb-2`}>por {recipe.author}</p>}
                        <p className={`text-sm ${THEME.textSec} mb-4 line-clamp-2`}>{isOfficial ? recipe.notes : recipe.desc}</p>
                        {isOfficial && <div className="flex items-center justify-between mt-3 pt-3 border-t border-zinc-700 border-opacity-50"><div className={`flex gap-4 text-xs ${THEME.textSec} font-medium`}><span className="flex items-center gap-1"><Icon name="droplet" size={12}/> {recipe.ratio}</span><span className="flex items-center gap-1"><Icon name="thermometer" size={12}/> {recipe.temp}</span></div><span className={`${THEME.accentText} text-sm font-bold flex items-center gap-1`}>Ver <Icon name="chevron-right" size={16} /></span></div>}
                    </div>
                </div>
            );
        };

        const TimerView = () => {
            const [activeMethod, setActiveMethod] = useState(BREW_METHODS[0]);
            const [time, setTime] = useState(0);
            const [isActive, setIsActive] = useState(false);
            useEffect(() => { let i; if(isActive) i = setInterval(() => setTime(t => t+1), 1000); return () => clearInterval(i); }, [isActive]);
            return (
                <div className="p-4 pb-24">
                    <h2 className={`text-xl font-bold mb-4 ${THEME.textMain}`}>Barista de Bolso</h2>
                    <div className="flex gap-3 overflow-x-auto pb-4 no-scrollbar mb-4">
                        {BREW_METHODS.map(m => (
                            <button key={m.name} onClick={() => { setActiveMethod(m); setTime(0); setIsActive(false); }} className={`flex flex-col items-center justify-center min-w-[80px] h-20 rounded-xl border transition-all ${activeMethod.name === m.name ? `${THEME.headerBg} ${THEME.headerText} border-yellow-500` : `${THEME.cardBg} ${THEME.textSec} border-zinc-700`}`}>
                                <Icon name={m.icon} size={24} className="mb-1" />
                                <span className="text-[10px] uppercase font-bold tracking-wider">{m.name.split(' ')[0]}</span>
                            </button>
                        ))}
                    </div>
                    <div className="flex flex-col items-center justify-center py-8">
                        <div className="relative w-64 h-64 flex items-center justify-center">
                            <div className={`absolute w-full h-full rounded-full border-4 border-zinc-700`}></div>
                            <div className={`absolute w-full h-full rounded-full border-4 border-t-current border-r-current transition-all duration-1000 ${isActive ? 'animate-spin-slow' : ''} ${THEME.accentText}`} style={{ borderRightColor: 'transparent', borderBottomColor: 'transparent', borderLeftColor: 'transparent' }}></div>
                            <div className="text-center z-10"><div className={`text-6xl font-black ${THEME.textMain} tabular-nums`}>{Math.floor(time/60)}:{(time%60).toString().padStart(2,'0')}</div><div className={`font-medium text-sm mt-1 uppercase tracking-widest ${THEME.textSec}`}>{isActive ? 'Extraindo' : 'Pronto'}</div></div>
                        </div>
                    </div>
                    <div className="flex justify-center gap-6">
                        <button onClick={() => {setIsActive(false); setTime(0);}} className={`w-14 h-14 rounded-full flex items-center justify-center hover:opacity-80 bg-zinc-800 text-white`}><Icon name="rotate-ccw" size={24} /></button>
                        <button onClick={() => setIsActive(!isActive)} className={`w-20 h-20 rounded-full flex items-center justify-center shadow-xl transition-transform active:scale-95 ${isActive ? `${THEME.headerBg} ${THEME.headerText}` : `${THEME.accent} text-black`}`}>{isActive ? <Icon name="pause" size={32} /> : <Icon name="play" size={32} className="ml-1" />}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [isLoadingUser, setIsLoadingUser] = useState(true);
            const [activeTab, setActiveTab] = useState('home');
            const [recipes, setRecipes] = useState([]);
            const [baristaMode, setBaristaMode] = useState(false);
            const [viewMode, setViewMode] = useState('normal');
            const [selectedRecipe, setSelectedRecipe] = useState(null);
            const [recipeToEdit, setRecipeToEdit] = useState(null);
            const [searchResults, setSearchResults] = useState(null);

            // Auth Listener
            useEffect(() => {
                if (!auth) {
                    setIsLoadingUser(false);
                    return;
                }
                const unsubscribe = auth.onAuthStateChanged(currentUser => {
                    setUser(currentUser);
                    setIsLoadingUser(false);
                });
                return () => unsubscribe();
            }, []);

            // Data Listener
            useEffect(() => {
                if (!db) return;
                const unsub = db.collection('recipes').orderBy('createdAt', 'desc').onSnapshot(snap => setRecipes(snap.docs.map(d => ({id:d.id, ...d.data()}))), e => console.log(e));
                return () => unsub();
            }, []);

            const forceUpdateUser = (userData) => { 
                setUser(userData); 
                setIsLoadingUser(false); 
            };

            const handleEditRecipe = (recipe) => {
                setRecipeToEdit(recipe);
                setViewMode('admin');
            };

            const findRecipesForCoffee = (coffeeName) => {
                if (!coffeeName) return;
                const lowerName = coffeeName.toLowerCase();
                const results = [...recipes, ...INITIAL_OFFICIAL_RECIPES].filter(r => 
                    r.title.toLowerCase().includes(lowerName) || 
                    (r.coffee && r.coffee.toLowerCase().includes(lowerName))
                );
                setSearchResults(results);
            };

            if (isLoadingUser) {
                return <div className="h-screen bg-zinc-900 flex items-center justify-center text-white"><span className="animate-spin text-3xl">☕</span></div>;
            }

            if (!user) {
                return <AuthView onLoginSuccess={forceUpdateUser} />;
            }

            const renderContent = () => {
                if (viewMode === 'admin') {
                    return <AdminRecipeForm 
                        initialData={recipeToEdit}
                        onSave={async (r) => { 
                            try { 
                                if (r.id) {
                                    await db.collection('recipes').doc(r.id).update({...r});
                                } else {
                                    await db.collection('recipes').add({...r, createdAt: new Date(), author: 'Moka Clube'}); 
                                }
                                setViewMode('normal'); 
                                setActiveTab('home'); 
                                setRecipeToEdit(null);
                            } catch(e){ alert(e.message); } 
                        }} 
                        onCancel={() => { setViewMode('normal'); setRecipeToEdit(null); }} 
                    />;
                }

                switch (activeTab) {
                    case 'timer': return <TimerView />;
                    case 'sensory': return <SensoryEvaluation onFindRecipes={findRecipesForCoffee} user={user} />;
                    case 'community': return (
                        <div className="p-4 pb-24">
                            <div className={`flex items-center gap-2 mb-6 ${THEME.cardBg} border ${THEME.border} p-2 rounded-lg`}>
                                <Icon name="search" size={20} className="text-gray-400 ml-2" />
                                <input type="text" placeholder="Buscar receitas..." className={`bg-transparent w-full p-1 outline-none ${THEME.textMain} text-sm`} />
                            </div>
                            <div className="flex justify-between items-end mb-4">
                                <div><h3 className={`font-bold text-xl ${THEME.textMain}`}>Comunidade Moka</h3><p className={`text-xs ${THEME.textSec}`}>O que os membros estão bebendo</p></div>
                                <button className={`${THEME.headerBg} ${THEME.headerText} p-2 rounded-full shadow-lg border border-zinc-700`}><Icon name="plus-circle" size={24} /></button>
                            </div>
                            {COMMUNITY_RECIPES.map(recipe => (
                                <RecipeCard key={recipe.id} recipe={recipe} isOfficial={false} onViewDetail={setSelectedRecipe} />
                            ))}
                        </div>
                    );
                    case 'profile': return <ProfileView user={user} baristaMode={baristaMode} setBaristaMode={setBaristaMode} />;
                    default: return (
                        <div className="p-4 pb-24">
                            <div className={`${THEME.headerBg} rounded-2xl p-5 mb-6 text-white relative overflow-hidden shadow-lg border border-zinc-700`}>
                                <div className={`absolute top-0 right-0 w-32 h-32 ${THEME.accent} rounded-full blur-3xl opacity-20 translate-x-10 -translate-y-10`}></div>
                                <span className={`${THEME.accent} text-black text-[10px] font-bold px-2 py-1 rounded mb-2 inline-block`}>CLUBE DE ASSINATURA</span>
                                <h2 className="relative z-10 text-xl font-bold mb-1">Café do Mês: Piatã</h2>
                                <button onClick={() => setActiveTab('sensory')} className={`relative z-10 ${THEME.cardBg} ${THEME.textMain} px-4 py-2 rounded-lg text-sm font-bold mt-2 hover:bg-zinc-700`}>Avaliar este Café</button>
                            </div>
                            <div className="flex items-center justify-between mb-4">
                                <h3 className={`font-bold text-lg ${THEME.textMain}`}>Receitas Oficiais</h3>
                                {baristaMode && <button onClick={() => { setRecipeToEdit(null); setViewMode('admin'); }} className={`flex items-center gap-1 ${THEME.accentText} text-xs font-bold border border-current px-2 py-1 rounded-full animate-pulse`}><Icon name="plus-circle" size={14} /> NOVA</button>}
                            </div>
                            {[...recipes, ...INITIAL_OFFICIAL_RECIPES].filter((v,i,a)=>a.findIndex(v2=>(v2.id===v.id))===i).map(recipe => (
                                <RecipeCard 
                                    key={recipe.id} 
                                    recipe={recipe} 
                                    isOfficial={true} 
                                    onViewDetail={setSelectedRecipe} 
                                    baristaMode={baristaMode}
                                    onEdit={handleEditRecipe}
                                />
                            ))}
                        </div>
                    );
                }
            };

            return (
                <ErrorBoundary>
                    <div className={`${THEME.bg} min-h-screen font-sans transition-colors duration-300 max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-zinc-800`}>
                        <Header baristaMode={baristaMode} />
                        <main className="min-h-[calc(100vh-140px)]">{renderContent()}</main>
                        {selectedRecipe && <RecipeDetailModal recipe={selectedRecipe} onClose={() => setSelectedRecipe(null)} user={user} />}
                        {searchResults && <RecipeSearchResultsModal recipes={searchResults} onClose={() => setSearchResults(null)} onViewDetail={setSelectedRecipe} />}
                        {viewMode !== 'admin' && (
                            <nav className={`fixed bottom-0 w-full max-w-md ${THEME.navBg} border-t ${THEME.border} flex justify-around py-3 pb-5 px-2 z-50 transition-colors duration-300`}>
                                <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'home' ? THEME.accentText : 'text-gray-500 hover:text-gray-300'}`}><Icon name="coffee" size={24} strokeWidth={activeTab === 'home' ? 2.5 : 2} /><span className="text-[10px] font-medium">Início</span></button>
                                <button onClick={() => setActiveTab('timer')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'timer' ? THEME.accentText : 'text-gray-500 hover:text-gray-300'}`}><Icon name="timer" size={24} strokeWidth={activeTab === 'timer' ? 2.5 : 2} /><span className="text-[10px] font-medium">Timer</span></button>
                                <button onClick={() => setActiveTab('sensory')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'sensory' ? THEME.accentText : 'text-gray-500 hover:text-gray-300'}`}><Icon name="bar-chart-2" size={24} strokeWidth={activeTab === 'sensory' ? 2.5 : 2} /><span className="text-[10px] font-medium">Avaliar</span></button>
                                <button onClick={() => setActiveTab('community')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'community' ? THEME.accentText : 'text-gray-500 hover:text-gray-300'}`}><Icon name="users" size={24} strokeWidth={activeTab === 'community' ? 2.5 : 2} /><span className="text-[10px] font-medium">Tribo</span></button>
                                <button onClick={() => setActiveTab('profile')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'profile' ? THEME.accentText : 'text-gray-500 hover:text-gray-300'}`}><div className={`w-6 h-6 rounded-full overflow-hidden border ${activeTab === 'profile' ? THEME.accent : 'border-zinc-700 bg-zinc-800'} relative flex items-center justify-center`}><span className="text-[8px] font-bold text-gray-500">EU</span></div><span className="text-[10px] font-medium">Perfil</span></button>
                            </nav>
                        )}
                    </div>
                </ErrorBoundary>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
